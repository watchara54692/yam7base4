<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7-Digit Astrology Tool (V2)</title>
    <style>
        :root { --primary: #1a2a3a; --gold: #c5a02e; --bg: #fdfdfd; }
        body { font-family: 'Tahoma', sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; justify-content: center; }
        .container { background: white; border: 1px solid #ddd; border-radius: 8px; max-width: 650px; width: 100%; padding: 12px; box-sizing: border-box; }
        
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        input, button { padding: 12px; border-radius: 5px; border: 1px solid #ccc; font-size: 15px; outline: none; }
        button { cursor: pointer; background: var(--primary); color: white; border: none; font-weight: bold; }
        .btn-now { background: var(--gold); }

        .result-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        td { border: 1px solid #333; text-align: center; vertical-align: middle; padding: 6px 0; height: 60px; }
        
        /* สไตล์ชื่อภพในช่อง */
        .house-label { font-size: 10px; color: #666; margin-bottom: 2px; display: block; }
        .digit-value { font-size: 22px; font-weight: bold; color: #000; display: block; }
        
        /* สไตล์แถวฐาน */
        .row-base { background: #fff9c4; border-top: 2px solid #333; }
        .base-label { font-size: 10px; color: #b71c1c; font-weight: bold; }
        .base-value { font-size: 22px; font-weight: bold; color: #b71c1c; }
        
        .info-panel { margin-top: 15px; font-size: 14px; padding: 10px; background: #f0f4f8; border-radius: 5px; text-align: center; border: 1px solid #d1d9e6; }
    </style>
</head>
<body>

<div class="container">
    <div class="controls">
        <input type="date" id="inputDate">
        <input type="time" id="inputTime">
        <button class="btn-now" onclick="setNow()">เวลาปัจจุบัน</button>
        <button onclick="calculateYam()">ตั้งดวงยาม</button>
    </div>

    <table class="result-table">
        <tbody id="tableBody">
            </tbody>
    </table>

    <div id="summaryInfo" class="info-panel" style="display:none;"></div>
</div>

<script>
    // นิยามภพทั้ง 21 ตามลำดับ
    const houseList = [
        ["อัตตะ", "หินะ", "ธนัง", "ปิตา", "มาตา", "โภคา", "มัชฌิมา"],
        ["ตนุ", "กดุมภะ", "สหัชชะ", "พันธุ", "ปุตตะ", "อริ", "ปัตนิ"],
        ["มรณะ", "สุภะ", "กัมมะ", "ลาภะ", "พยายะ", "ทาสา", "ทาสี"]
    ];
    
    const yamSequence = [1, 6, 4, 2, 7, 5, 3];

    function setNow() {
        const now = new Date();
        document.getElementById('inputDate').valueAsDate = now;
        document.getElementById('inputTime').value = now.toTimeString().substring(0,5);
        calculateYam();
    }

    function calculateYam() {
        const dIn = document.getElementById('inputDate').value;
        const tIn = document.getElementById('inputTime').value;
        if(!dIn || !tIn) return;

        let dt = new Date(dIn + 'T' + tIn);
        let dayOfWeek = dt.getDay() === 0 ? 1 : dt.getDay() + 1;
        let hours = dt.getHours();
        let minutes = dt.getMinutes();
        let totalMin = (hours * 60) + minutes;

        // ปรับวันทางโหราศาสตร์
        let bioDay = (hours < 6) ? (dayOfWeek === 1 ? 7 : dayOfWeek - 1) : dayOfWeek;
        
        // คำนวณยาม
        let isNight = (totalMin >= 1080 || totalMin < 360);
        let refTime = isNight ? (totalMin < 360 ? totalMin + 1440 : totalMin) - 1080 : totalMin - 360;
        let yamIdx = Math.floor(refTime / 90) + 1;
        
        let firstY = isNight ? ((bioDay + 4 > 7) ? bioDay + 4 - 7 : bioDay + 4) : bioDay;
        let mYam = firstY;
        for(let i=1; i < yamIdx; i++) {
            let next = yamSequence.indexOf(mYam) + 1;
            mYam = yamSequence[next > 6 ? 0 : next];
        }

        let minInYam = refTime % 90;
        let lYamIdx = Math.floor(minInYam / 12.85) + 1;
        let lYam = (mYam + lYamIdx - 1) > 7 ? (mYam + lYamIdx - 1) % 7 || 7 : (mYam + lYamIdx - 1);

        renderTable(bioDay, mYam, lYam, isNight, yamIdx, lYamIdx);
    }

    function renderTable(d, y, ly, night, yIdx, lyIdx) {
        const tableBody = document.getElementById('tableBody');
        tableBody.innerHTML = ''; // ล้างตารางเดิม

        const results = [[], [], []];
        const baseRow = [];

        // คำนวณเลขดาวทั้ง 3 แถว
        for(let i=0; i<7; i++) {
            results[0].push((d + i) > 7 ? (d + i) % 7 || 7 : (d + i));
            results[1].push((y + i) > 7 ? (y + i) % 7 || 7 : (y + i));
            results[2].push((ly + i) > 7 ? (ly + i) % 7 || 7 : (ly + i));
            baseRow.push(results[0][i] + results[1][i] + results[2][i]);
        }

        // สร้างแถวข้อมูล 1-3
        for(let r=0; r<3; r++) {
            let tr = document.createElement('tr');
            for(let c=0; c<7; c++) {
                tr.innerHTML += `
                    <td>
                        <span class="house-label">${houseList[r][c]}</span>
                        <span class="digit-value">${results[r][c]}</span>
                    </td>
                `;
            }
            tableBody.appendChild(tr);
        }

        // สร้างแถวฐาน (แถวที่ 4)
        let trBase = document.createElement('tr');
        trBase.className = 'row-base';
        for(let b=0; b<7; b++) {
            trBase.innerHTML += `
                <td>
                    <span class="base-label">ฐาน</span>
                    <span class="base-value">${baseRow[b]}</span>
                </td>
            `;
        }
        tableBody.appendChild(trBase);

        const info = document.getElementById('summaryInfo');
        info.style.display = 'block';
        info.innerHTML = `<strong>ยามที่ ${yIdx} (${night ? 'กลางคืน' : 'กลางวัน'}) | ลูกยามที่ ${lyIdx}</strong><br>รหัส: ${results[0][0]} - ${results[1][0]} - ${results[2][0]} ฐาน ${baseRow[0]}`;
    }

    window.onload = setNow;
</script>

</body>
</html>
