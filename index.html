<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7-Digit Astrology Tool</title>
    <style>
        :root { --primary: #1a2a3a; --gold: #c5a02e; --bg: #fdfdfd; }
        body { font-family: 'Tahoma', sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; justify-content: center; }
        .container { background: white; border: 1px solid #ddd; border-radius: 8px; max-width: 600px; width: 100%; padding: 10px; box-sizing: border-box; }
        
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        input, button { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; outline: none; }
        button { cursor: pointer; background: var(--primary); color: white; border: none; font-weight: bold; }
        .btn-now { background: var(--gold); }

        .result-table { width: 100%; border-collapse: collapse; table-layout: fixed; margin-top: 10px; }
        th, td { border: 1px solid #444; text-align: center; vertical-align: middle; padding: 4px 1px; }
        
        /* หัวตาราง 21 ภพ */
        .house-header { font-size: 10px; line-height: 1.2; background: #eee; height: 50px; }
        .house-group { border-bottom: 1px solid #ccc; padding: 2px 0; }
        .house-group:last-child { border-bottom: none; }

        .digit-cell { font-size: 18px; font-weight: bold; height: 40px; }
        .row-base { background: #fff9c4; color: #b71c1c; font-size: 20px; }
        
        .info-panel { margin-top: 12px; font-size: 13px; padding: 8px; background: #f0f4f8; border-radius: 5px; text-align: center; border: 1px solid #d1d9e6; }
        strong { color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <div class="controls">
        <input type="date" id="inputDate">
        <input type="time" id="inputTime">
        <button class="btn-now" onclick="setNow()">เวลาปัจจุบัน</button>
        <button onclick="calculateYam()">ตั้งดวงยาม</button>
    </div>

    <table class="result-table" id="yamTable">
        <thead>
            <tr id="headerRow" class="house-header"></tr>
        </thead>
        <tbody id="digitBody">
            <tr id="row1" class="digit-cell"></tr>
            <tr id="row2" class="digit-cell"></tr>
            <tr id="row3" class="digit-cell"></tr>
            <tr id="row4" class="digit-cell row-base"></tr>
        </tbody>
    </table>

    <div id="summaryInfo" class="info-panel" style="display:none;"></div>
</div>

<script>
    const houses = [
        ["อัตตะ", "ตนุ", "มรณะ"],
        ["หินะ", "กดุมภะ", "สุภะ"],
        ["ธนัง", "สหัชชะ", "กัมมะ"],
        ["ปิตา", "พันธุ", "ลาภะ"],
        ["มาตา", "ปุตตะ", "พยายะ"],
        ["โภคา", "อริ", "ทาสา"],
        ["มัชฌิมา", "ปัตนิ", "ทาสี"]
    ];
    const yamSequence = [1, 6, 4, 2, 7, 5, 3];

    function setNow() {
        const now = new Date();
        document.getElementById('inputDate').valueAsDate = now;
        document.getElementById('inputTime').value = now.toTimeString().substring(0,5);
        calculateYam();
    }

    function calculateYam() {
        const dIn = document.getElementById('inputDate').value;
        const tIn = document.getElementById('inputTime').value;
        if(!dIn || !tIn) return;

        let dt = new Date(dIn + 'T' + tIn);
        let dayOfWeek = dt.getDay() === 0 ? 1 : dt.getDay() + 1;
        let hours = dt.getHours();
        let minutes = dt.getMinutes();
        let totalMin = (hours * 60) + minutes;

        let bioDay = (hours < 6) ? (dayOfWeek === 1 ? 7 : dayOfWeek - 1) : dayOfWeek;
        let isNight = (totalMin >= 1080 || totalMin < 360);
        let refTime = isNight ? (totalMin < 360 ? totalMin + 1440 : totalMin) - 1080 : totalMin - 360;
        let yamIdx = Math.floor(refTime / 90) + 1;
        
        let firstY = isNight ? ((bioDay + 4 > 7) ? bioDay + 4 - 7 : bioDay + 4) : bioDay;
        let mYam = firstY;
        for(let i=1; i < yamIdx; i++) {
            let next = yamSequence.indexOf(mYam) + 1;
            mYam = yamSequence[next > 6 ? 0 : next];
        }

        let minInYam = refTime % 90;
        let lYamIdx = Math.floor(minInYam / 12.85) + 1;
        let lYam = (mYam + lYamIdx - 1) > 7 ? (mYam + lYamIdx - 1) % 7 || 7 : (mYam + lYamIdx - 1);

        renderTable(bioDay, mYam, lYam, isNight, yamIdx, lYamIdx);
    }

    function renderTable(d, y, ly, night, yIdx, lyIdx) {
        let hHtml = '';
        houses.forEach(group => {
            hHtml += `<th><div class="house-group">${group[0]}</div><div class="house-group">${group[1]}</div><div class="house-group">${group[2]}</div></th>`;
        });
        document.getElementById('headerRow').innerHTML = hHtml;

        const res = [[], [], [], []];
        for(let i=0; i<7; i++) {
            let v1 = (d + i) > 7 ? (d + i) % 7 || 7 : (d + i);
            let v2 = (y + i) > 7 ? (y + i) % 7 || 7 : (y + i);
            let v3 = (ly + i) > 7 ? (ly + i) % 7 || 7 : (ly + i);
            res[0].push(v1); res[1].push(v2); res[2].push(v3); res[3].push(v1 + v2 + v3);
        }

        for(let j=0; j<4; j++) {
            document.getElementById(`row${j+1}`).innerHTML = res[j].map(v => `<td>${v}</td>`).join('');
        }

        const info = document.getElementById('summaryInfo');
        info.style.display = 'block';
        info.innerHTML = `<strong>ยาม ${yIdx} (${night ? 'กลางคืน' : 'กลางวัน'}) | ลูกยามที่ ${lyIdx}</strong><br>รหัส: ${res[0][0]} - ${res[1][0]} - ${res[2][0]} ฐาน ${res[3][0]}`;
    }

    window.onload = setNow;
</script>

</body>
</html>
